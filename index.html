
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏàòÌïô Î†àÎ≤®ÏóÖ Í≤åÏûÑ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* ÏãúÏûë ÌôîÎ©¥ Ïä§ÌÉÄÏùº */
        .start-screen {
            text-align: center;
            padding: 30px 20px;
            display: block;
        }

        .start-screen.hidden {
            display: none;
        }

        .start-title {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 40px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .character-selection {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .character-option {
            font-size: 50px;
            padding: 15px;
            background: white;
            border: 4px solid #cbd5e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1;
        }

        .character-option:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .character-option.selected {
            border-color: #667eea;
            background: #e6f2ff;
            transform: scale(1.1);
        }

        .difficulty-selection {
            margin-bottom: 40px;
        }

        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            max-width: 700px;
            margin: 0 auto;
        }

        .difficulty-option {
            padding: 20px 15px;
            font-size: 16px;
            border: 4px solid #f39c12;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: #f39c12;
        }

        .difficulty-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .difficulty-option.selected {
            background: #f39c12;
            color: white;
            transform: scale(1.05);
        }

        .start-btn {
            padding: 20px 60px;
            font-size: 1.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 30px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Í≤åÏûÑ ÌôîÎ©¥ Ïä§ÌÉÄÏùº */
        .game-screen {
            display: none;
        }

        .game-screen.active {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            position: relative;
        }

        h1 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .character-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 15px;
        }

        .character-display {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .character {
            font-size: 60px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .character-info {
            text-align: left;
        }

        .level {
            font-size: 1.5em;
            font-weight: bold;
            color: #d63031;
            margin-bottom: 5px;
        }

        .exp-bar {
            width: 180px;
            height: 25px;
            background: #dfe6e9;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b894 0%, #00cec9 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .stats-compact {
            text-align: right;
            font-size: 0.95em;
            color: #2d3748;
        }

        .stats-compact div {
            margin-bottom: 3px;
        }

        .problem-type-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 12px;
        }

        .type-btn {
            padding: 8px 12px;
            font-size: 13px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: #667eea;
        }

        .type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .type-btn.active {
            background: #667eea;
            color: white;
        }

        .problem-container {
            padding: 15px;
            background: #f7fafc;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 3px solid #e2e8f0;
            position: relative;
        }

        .drawing-controls {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .drawing-btn {
            padding: 5px 10px;
            font-size: 11px;
            border: 2px solid #cbd5e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .drawing-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .drawing-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .color-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #cbd5e0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.active {
            border-color: #2d3748;
            border-width: 3px;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 280px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        #problemCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            pointer-events: none;
        }

        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            cursor: crosshair;
        }

        .format-selector {
            text-align: center;
            margin-bottom: 10px;
        }

        .format-btn {
            padding: 6px 12px;
            margin: 0 3px;
            font-size: 12px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: #667eea;
        }

        .format-btn:hover {
            transform: translateY(-1px);
        }

        .format-btn.active {
            background: #667eea;
            color: white;
        }

        .answer-section {
            text-align: center;
        }

        .answer-display {
            font-size: 1.6em;
            margin-bottom: 12px;
            color: #2d3748;
            min-height: 35px;
            font-weight: bold;
        }

        .number-pad {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 500px;
            margin: 0 auto 12px;
        }

        .number-row {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .num-btn {
            padding: 12px 16px;
            font-size: 1.4em;
            background: white;
            border: 3px solid #cbd5e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            color: #2d3748;
            flex: 1;
            max-width: 70px;
        }

        .num-btn:hover {
            background: #edf2f7;
            transform: scale(1.05);
        }

        .num-btn:active {
            transform: scale(0.95);
        }

        .btn-clear {
            background: #fc8181;
            border-color: #fc8181;
            color: white;
        }

        .btn-clear:hover {
            background: #f56565;
        }

        .btn-submit {
            padding: 12px 30px;
            font-size: 1.2em;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-submit:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .result-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 1000;
            text-align: center;
            transition: transform 0.3s;
            max-width: 90%;
        }

        .result-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .result-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .result-text {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .result-correct {
            color: #48bb78;
        }

        .result-incorrect {
            color: #f56565;
        }

        .btn-next {
            padding: 12px 30px;
            font-size: 1.1em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .btn-next:hover {
            background: #5568d3;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        .restart-btn {
            position: absolute;
            top: 0;
            right: 0;
            padding: 6px 12px;
            font-size: 12px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .restart-btn:hover {
            background: #c53030;
            transform: scale(1.05);
        }

        /* Î™®Î∞îÏùº Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }

            .start-title {
                font-size: 1.8em;
                margin-bottom: 30px;
            }

            h1 {
                font-size: 1.5em;
            }

            .character-grid {
                gap: 10px;
            }

            .character-option {
                font-size: 40px;
                padding: 10px;
            }

            .difficulty-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .difficulty-option {
                padding: 15px 10px;
                font-size: 14px;
            }

            .start-btn {
                padding: 15px 40px;
                font-size: 1.2em;
            }

            .section-title {
                font-size: 1.2em;
            }

            .character-section {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                padding: 12px;
            }

            .character-display {
                flex-direction: column;
                gap: 10px;
            }

            .character {
                font-size: 50px;
            }

            .level {
                font-size: 1.3em;
            }

            .exp-bar {
                width: 160px;
                height: 22px;
            }

            .exp-fill {
                font-size: 11px;
            }

            .stats-compact {
                text-align: center;
                font-size: 0.85em;
            }

            .type-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .problem-container {
                padding: 12px;
            }

            .canvas-container {
                height: 240px;
            }

            .drawing-btn {
                padding: 4px 8px;
                font-size: 10px;
            }

            .color-btn {
                width: 26px;
                height: 26px;
            }

            .answer-display {
                font-size: 1.4em;
            }

            .num-btn {
                padding: 10px 14px;
                font-size: 1.2em;
                max-width: 60px;
            }

            .btn-submit {
                padding: 10px 25px;
                font-size: 1em;
            }

            .result-icon {
                font-size: 50px;
            }

            .result-text {
                font-size: 1.5em;
            }
        }

        @media (max-width: 480px) {
            .start-title {
                font-size: 1.5em;
            }

            h1 {
                font-size: 1.3em;
            }

            .character-grid {
                gap: 8px;
            }

            .character-option {
                font-size: 35px;
                padding: 8px;
            }

            .difficulty-grid {
                grid-template-columns: 1fr;
            }

            .character {
                font-size: 45px;
            }

            .level {
                font-size: 1.2em;
            }

            .exp-bar {
                width: 140px;
                height: 20px;
            }

            .exp-fill {
                font-size: 10px;
            }

            .stats-compact {
                font-size: 0.8em;
            }

            .canvas-container {
                height: 200px;
            }

            .num-btn {
                padding: 8px 12px;
                font-size: 1.1em;
                max-width: 55px;
            }

            .answer-display {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ÏãúÏûë ÌôîÎ©¥ -->
        <div class="start-screen" id="startScreen">
            <h1 class="start-title">üéÆ ÏàòÌïô Î†àÎ≤®ÏóÖ Í≤åÏûÑ</h1>

            <div class="character-selection">
                <div class="section-title">üêæ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
                <div class="character-grid" id="characterGrid">
                    <div class="character-option" data-char="üê±">üê±</div>
                    <div class="character-option" data-char="üê∂">üê∂</div>
                    <div class="character-option" data-char="üêº">üêº</div>
                    <div class="character-option" data-char="ü¶Å">ü¶Å</div>
                    <div class="character-option" data-char="üêØ">üêØ</div>
                    <div class="character-option" data-char="ü¶ä">ü¶ä</div>
                    <div class="character-option" data-char="üê∞">üê∞</div>
                    <div class="character-option" data-char="üêª">üêª</div>
                    <div class="character-option" data-char="üê®">üê®</div>
                    <div class="character-option" data-char="üêµ">üêµ</div>
                </div>
            </div>

            <div class="difficulty-selection">
                <div class="section-title">‚≠ê ÎÇúÏù¥ÎèÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
                <div class="difficulty-grid">
                    <div class="difficulty-option" data-difficulty="1">
                        ‚≠ê 1Îã®Í≥Ñ<br><small>1ÏûêÎ¶¨ Ïàò (1~9)</small>
                    </div>
                    <div class="difficulty-option" data-difficulty="2">
                        ‚≠ê‚≠ê 2Îã®Í≥Ñ<br><small>2ÏûêÎ¶¨ Ïàò (10~99)</small>
                    </div>
                    <div class="difficulty-option" data-difficulty="3">
                        ‚≠ê‚≠ê‚≠ê 3Îã®Í≥Ñ<br><small>3ÏûêÎ¶¨ Ïàò (100~999)</small>
                    </div>
                    <div class="difficulty-option" data-difficulty="4">
                        ‚≠ê‚≠ê‚≠ê‚≠ê 4Îã®Í≥Ñ<br><small>4ÏûêÎ¶¨ Ïàò (1000~9999)</small>
                    </div>
                    <div class="difficulty-option" data-difficulty="5">
                        ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5Îã®Í≥Ñ<br><small>5ÏûêÎ¶¨ Ïàò (10000~99999)</small>
                    </div>
                    <div class="difficulty-option" data-difficulty="6">
                        ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 6Îã®Í≥Ñ<br><small>6ÏûêÎ¶¨ Ïàò (100000~999999)</small>
                    </div>
                </div>
            </div>

            <button class="start-btn" id="startGameBtn" disabled>Í≤åÏûÑ ÏãúÏûë!</button>
        </div>

        <!-- Í≤åÏûÑ ÌôîÎ©¥ -->
        <div class="game-screen" id="gameScreen">
            <div class="header">
                <h1>üéÆ ÏàòÌïô Î†àÎ≤®ÏóÖ Í≤åÏûÑ</h1>
                <button class="restart-btn" onclick="restartGame()">üîÑ Ï≤òÏùåÏúºÎ°ú</button>
            </div>

            <div class="character-section">
                <div class="character-display">
                    <div class="character" id="character">üê±</div>
                    <div class="character-info">
                        <div class="level" id="level">Level 1</div>
                        <div class="exp-bar">
                            <div class="exp-fill" id="expFill">0 / 20</div>
                        </div>
                    </div>
                </div>
                <div class="stats-compact">
                    <div>Ï†ïÎãµ: <span id="correctCount">0</span>Í∞ú ‚úì</div>
                    <div>Ï¥ù Î¨∏Ï†ú: <span id="totalCount">0</span>Í∞ú</div>
                </div>
            </div>

            <div class="problem-type-selector">
                <button class="type-btn active" onclick="selectType('all')">Ï†ÑÏ≤¥</button>
                <button class="type-btn" onclick="selectType('addition')">‚ûï ÎçßÏÖà</button>
                <button class="type-btn" onclick="selectType('subtraction')">‚ûñ Î∫ÑÏÖà</button>
                <button class="type-btn" onclick="selectType('multiplication')">‚úñÔ∏è Í≥±ÏÖà</button>
                <button class="type-btn" onclick="selectType('division')">‚ûó ÎÇòÎàóÏÖà</button>
                <button class="type-btn" onclick="selectType('word')">üìù ÏÑúÏà†Ìòï</button>
            </div>

            <div class="problem-container">
                <div class="drawing-controls">
                    <button class="drawing-btn" onclick="toggleDrawing()" id="drawingToggle">üñäÔ∏è Í∑∏Î¶ºÌåê</button>
                    <button class="color-btn" onclick="changeColor('#000000')" style="background: #000000;" id="color-black"></button>
                    <button class="color-btn" onclick="changeColor('#ff0000')" style="background: #ff0000;"></button>
                    <button class="color-btn" onclick="changeColor('#0000ff')" style="background: #0000ff;"></button>
                    <button class="color-btn" onclick="changeColor('#00ff00')" style="background: #00ff00;"></button>
                    <button class="drawing-btn" onclick="changeLineWidth(2)">Í∞ÄÎäî ÏÑ†</button>
                    <button class="drawing-btn" onclick="changeLineWidth(8)">ÍµµÏùÄ ÏÑ†</button>
                    <button class="drawing-btn" onclick="useEraser()">ÏßÄÏö∞Í∞ú</button>
                    <button class="drawing-btn" onclick="clearCanvas()">ÏßÄÏö∞Í∏∞</button>
                </div>

                <div class="format-selector" id="formatSelector" style="display: none;">
                    <button class="format-btn active" onclick="changeFormat('inline')">ÏùºÏûêÌòï</button>
                    <button class="format-btn" onclick="changeFormat('vertical')">ÎëêÏ§ÑÌòï</button>
                </div>

                <div class="canvas-container">
                    <canvas id="drawingCanvas"></canvas>
                    <canvas id="problemCanvas"></canvas>
                </div>

                <div class="answer-section">
                    <div class="answer-display" id="answerDisplay">Îãµ: </div>
                    <div class="number-pad">
                        <div class="number-row">
                            <button class="num-btn" onclick="addNumber(1)">1</button>
                            <button class="num-btn" onclick="addNumber(2)">2</button>
                            <button class="num-btn" onclick="addNumber(3)">3</button>
                            <button class="num-btn" onclick="addNumber(4)">4</button>
                            <button class="num-btn" onclick="addNumber(5)">5</button>
                        </div>
                        <div class="number-row">
                            <button class="num-btn" onclick="addNumber(6)">6</button>
                            <button class="num-btn" onclick="addNumber(7)">7</button>
                            <button class="num-btn" onclick="addNumber(8)">8</button>
                            <button class="num-btn" onclick="addNumber(9)">9</button>
                            <button class="num-btn" onclick="addNumber(0)">0</button>
                            <button class="num-btn btn-clear" onclick="clearAnswer()">‚Üê</button>
                        </div>
                    </div>
                    <button class="btn-submit" onclick="checkAnswer()">Ï†úÏ∂úÌïòÍ∏∞</button>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="result-popup" id="resultPopup">
        <div class="result-icon" id="resultIcon"></div>
        <div class="result-text" id="resultText"></div>
        <div id="expGain"></div>
        <button class="btn-next" onclick="nextProblem()">Îã§Ïùå Î¨∏Ï†ú</button>
    </div>

    <script>
        let currentType = 'all';
        let currentProblem = null;
        let currentFormat = 'inline';
        let currentAnswer = '';
        let currentDifficulty = 3;
        let level = 1;
        let exp = 0;
        let expNeeded = 20;
        let correctCount = 0;
        let totalCount = 0;
        let selectedCharacter = null;
        let selectedDifficulty = null;
        let initialCharacter = 'üê±';

        // Í∑∏Î¶ºÌåê Í¥ÄÎ†® Î≥ÄÏàò
        let drawingCanvas, problemCanvas;
        let drawingCtx, problemCtx;
        let isDrawing = false;
        let drawingEnabled = false;
        let currentColor = '#000000';
        let currentLineWidth = 3;
        let lastX = 0;
        let lastY = 0;

        const characters = ['üê±', 'üê∂', 'üêº', 'ü¶Å', 'üêØ', 'ü¶ä', 'üê∞', 'üêª', 'üê®', 'üêµ'];

        // ÏãúÏûë ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            initStartScreen();
        });

        function initStartScreen() {
            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.character-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.character-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedCharacter = this.dataset.char;
                    checkStartReady();
                });
            });

            // ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.difficulty-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDifficulty = parseInt(this.dataset.difficulty);
                    checkStartReady();
                });
            });

            // Í≤åÏûÑ ÏãúÏûë Î≤ÑÌäº
            document.getElementById('startGameBtn').addEventListener('click', startGame);
        }

        function checkStartReady() {
            const startBtn = document.getElementById('startGameBtn');
            if (selectedCharacter && selectedDifficulty) {
                startBtn.disabled = false;
            }
        }

        function startGame() {
            // Ï¥àÍ∏∞ ÏÑ§Ï†ï
            initialCharacter = selectedCharacter;
            currentDifficulty = selectedDifficulty;

            // ÌôîÎ©¥ Ï†ÑÌôò
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('active');

            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ§Ï†ï
            document.getElementById('character').textContent = initialCharacter;

            // Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî Î∞è Ï≤´ Î¨∏Ï†ú ÏÉùÏÑ±
            initCanvas();
            generateProblem();
        }

        function restartGame() {
            // Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            level = 1;
            exp = 0;
            expNeeded = 20;
            correctCount = 0;
            totalCount = 0;
            selectedCharacter = null;
            selectedDifficulty = null;

            // UI Ï¥àÍ∏∞Ìôî
            document.getElementById('level').textContent = 'Level 1';
            document.getElementById('expFill').textContent = '0 / 20';
            document.getElementById('expFill').style.width = '0%';
            document.getElementById('correctCount').textContent = '0';
            document.getElementById('totalCount').textContent = '0';

            // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.character-option').forEach(o => o.classList.remove('selected'));
            document.querySelectorAll('.difficulty-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('startGameBtn').disabled = true;

            // ÌôîÎ©¥ Ï†ÑÌôò
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('startScreen').classList.remove('hidden');
        }

        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî
        function initCanvas() {
            drawingCanvas = document.getElementById('drawingCanvas');
            problemCanvas = document.getElementById('problemCanvas');
            drawingCtx = drawingCanvas.getContext('2d');
            problemCtx = problemCanvas.getContext('2d');

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Í∑∏Î¶ºÌåê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);

            // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏
            drawingCanvas.addEventListener('touchstart', handleTouch);
            drawingCanvas.addEventListener('touchmove', handleTouch);
            drawingCanvas.addEventListener('touchend', stopDrawing);

            document.getElementById('color-black').classList.add('active');
        }

        function resizeCanvas() {
            const container = drawingCanvas.parentElement;
            const width = container.offsetWidth;
            const height = container.offsetHeight;

            drawingCanvas.width = width;
            drawingCanvas.height = height;
            problemCanvas.width = width;
            problemCanvas.height = height;

            drawingCtx.clearRect(0, 0, width, height);

            if (currentProblem) {
                displayProblem();
            }
        }

        function toggleDrawing() {
            drawingEnabled = !drawingEnabled;
            const btn = document.getElementById('drawingToggle');
            if (drawingEnabled) {
                btn.textContent = 'üñäÔ∏è ÎÅÑÍ∏∞';
                btn.classList.add('active');
            } else {
                btn.textContent = 'üñäÔ∏è Í∑∏Î¶ºÌåê';
                btn.classList.remove('active');
            }
        }

        function startDrawing(e) {
            if (!drawingEnabled) return;
            isDrawing = true;
            const rect = drawingCanvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing || !drawingEnabled) return;

            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            drawingCtx.beginPath();
            drawingCtx.moveTo(lastX, lastY);
            drawingCtx.lineTo(x, y);
            drawingCtx.strokeStyle = currentColor;
            drawingCtx.lineWidth = currentLineWidth;
            drawingCtx.lineCap = 'round';
            drawingCtx.stroke();

            lastX = x;
            lastY = y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            if (!drawingEnabled) return;

            const touch = e.touches[0];
            const rect = drawingCanvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            if (e.type === 'touchstart') {
                isDrawing = true;
                lastX = x;
                lastY = y;
            } else if (e.type === 'touchmove' && isDrawing) {
                drawingCtx.beginPath();
                drawingCtx.moveTo(lastX, lastY);
                drawingCtx.lineTo(x, y);
                drawingCtx.strokeStyle = currentColor;
                drawingCtx.lineWidth = currentLineWidth;
                drawingCtx.lineCap = 'round';
                drawingCtx.stroke();

                lastX = x;
                lastY = y;
            }
        }

        function changeColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function changeLineWidth(width) {
            currentLineWidth = width;
        }

        function useEraser() {
            currentColor = '#ffffff';
            currentLineWidth = 20;
        }

        function clearCanvas() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        }

        function selectType(type) {
            currentType = type;
            currentFormat = 'inline';
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            generateProblem();
        }

        function changeFormat(format) {
            currentFormat = format;
            document.querySelectorAll('.format-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayProblem();
        }

        function addNumber(num) {
            currentAnswer += num.toString();
            document.getElementById('answerDisplay').textContent = 'Îãµ: ' + currentAnswer;
        }

        function clearAnswer() {
            currentAnswer = currentAnswer.slice(0, -1);
            document.getElementById('answerDisplay').textContent = 'Îãµ: ' + (currentAnswer || '');
        }

        function generateProblem() {
            currentAnswer = '';
            document.getElementById('answerDisplay').textContent = 'Îãµ: ';
            clearCanvas();

            const types = currentType === 'all' 
                ? ['addition', 'subtraction', 'multiplication', 'division', 'word']
                : [currentType];

            const selectedType = types[random(0, types.length - 1)];

            if (selectedType === 'addition') {
                currentProblem = generateAddition();
            } else if (selectedType === 'subtraction') {
                currentProblem = generateSubtraction();
            } else if (selectedType === 'multiplication') {
                currentProblem = generateMultiplication();
            } else if (selectedType === 'division') {
                currentProblem = generateDivision();
            } else {
                currentProblem = generateWordProblem();
            }

            displayProblem();
        }

        function generateAddition() {
            let min, max;
            switch(currentDifficulty) {
                case 1: min = 1; max = 9; break;
                case 2: min = 10; max = 99; break;
                case 3: min = 100; max = 999; break;
                case 4: min = 1000; max = 9999; break;
                case 5: min = 10000; max = 99999; break;
                case 6: min = 100000; max = 999999; break;
            }
            const a = random(min, max);
            const b = random(min, max);
            return {
                type: 'addition',
                a, b,
                answer: a + b,
                canToggleFormat: true
            };
        }

        function generateSubtraction() {
            let min, max;
            switch(currentDifficulty) {
                case 1: min = 1; max = 9; break;
                case 2: min = 10; max = 99; break;
                case 3: min = 100; max = 999; break;
                case 4: min = 1000; max = 9999; break;
                case 5: min = 10000; max = 99999; break;
                case 6: min = 100000; max = 999999; break;
            }
            const a = random(min, max);
            const b = random(Math.floor(min/2), a - 1);
            return {
                type: 'subtraction',
                a, b,
                answer: a - b,
                canToggleFormat: true
            };
        }

        function generateMultiplication() {
            let minA, maxA, minB, maxB;
            switch(currentDifficulty) {
                case 1: minA = 1; maxA = 9; minB = 1; maxB = 9; break;
                case 2: minA = 10; maxA = 99; minB = 1; maxB = 9; break;
                case 3: minA = 10; maxA = 99; minB = 10; maxB = 99; break;
                case 4: minA = 100; maxA = 999; minB = 10; maxB = 99; break;
                case 5: minA = 100; maxA = 999; minB = 100; maxB = 999; break;
                case 6: minA = 1000; maxA = 9999; minB = 100; maxB = 999; break;
            }
            const a = random(minA, maxA);
            const b = random(minB, maxB);
            return {
                type: 'multiplication',
                a, b,
                answer: a * b,
                canToggleFormat: true
            };
        }

        function generateDivision() {
            let minDiv, maxDiv, minQuot, maxQuot;
            switch(currentDifficulty) {
                case 1: minDiv = 1; maxDiv = 9; minQuot = 1; maxQuot = 9; break;
                case 2: minDiv = 1; maxDiv = 9; minQuot = 10; maxQuot = 99; break;
                case 3: minDiv = 10; maxDiv = 99; minQuot = 10; maxQuot = 99; break;
                case 4: minDiv = 10; maxDiv = 99; minQuot = 100; maxQuot = 999; break;
                case 5: minDiv = 100; maxDiv = 999; minQuot = 100; maxQuot = 999; break;
                case 6: minDiv = 100; maxDiv = 999; minQuot = 1000; maxQuot = 9999; break;
            }
            const divisor = random(minDiv, maxDiv);
            const quotient = random(minQuot, maxQuot);
            const dividend = divisor * quotient;
            return {
                type: 'division',
                dividend, divisor,
                answer: quotient,
                canToggleFormat: false
            };
        }

        function generateWordProblem() {
            const type = random(1, 4);
            let problem, answer;
            let min, max;

            switch(currentDifficulty) {
                case 1: min = 1; max = 9; break;
                case 2: min = 10; max = 99; break;
                case 3: min = 100; max = 999; break;
                case 4: min = 1000; max = 9999; break;
                case 5: min = 10000; max = 99999; break;
                case 6: min = 100000; max = 999999; break;
            }

            if (type === 1) {
                const a = random(min, max);
                const b = random(min, max);
                answer = a + b;
                problem = `Ï≤†ÏàòÎäî ÏÇ¨Í≥ºÎ•º ${a}Í∞ú Í∞ÄÏßÄÍ≥† ÏûàÏóàÏäµÎãàÎã§. ÏòÅÌù¨Í∞Ä ÏÇ¨Í≥º ${b}Í∞úÎ•º Îçî Ï£ºÏóàÏäµÎãàÎã§. Ï≤†ÏàòÍ∞Ä Í∞ÄÏßÑ ÏÇ¨Í≥ºÎäî Î™®Îëê Î™á Í∞úÏûÖÎãàÍπå?`;
            } else if (type === 2) {
                const a = random(Math.floor(min * 1.5), max);
                const b = random(min, a - 1);
                answer = a - b;
                problem = `Í∞ÄÍ≤åÏóê ÎπµÏù¥ ${a}Í∞ú ÏûàÏóàÏäµÎãàÎã§. ÏÜêÎãòÎì§Ïù¥ ${b}Í∞úÎ•º ÏÉÄÏäµÎãàÎã§. ÎÇ®ÏùÄ ÎπµÏùÄ Î™á Í∞úÏûÖÎãàÍπå?`;
            } else if (type === 3) {
                let minMult, maxMult, minCount, maxCount;
                if (currentDifficulty === 1) {
                    minMult = 1; maxMult = 9; minCount = 1; maxCount = 9;
                } else if (currentDifficulty === 2) {
                    minMult = 10; maxMult = 99; minCount = 1; maxCount = 9;
                } else if (currentDifficulty === 3) {
                    minMult = 10; maxMult = 99; minCount = 10; maxCount = 99;
                } else if (currentDifficulty === 4) {
                    minMult = 100; maxMult = 999; minCount = 10; maxCount = 99;
                } else if (currentDifficulty === 5) {
                    minMult = 100; maxMult = 999; minCount = 100; maxCount = 999;
                } else {
                    minMult = 1000; maxMult = 9999; minCount = 100; maxCount = 999;
                }
                const a = random(minMult, maxMult);
                const b = random(minCount, maxCount);
                answer = a * b;
                problem = `Ìïú ÏÉÅÏûêÏóê Ïó∞ÌïÑÏù¥ ${a}ÏûêÎ£®Ïî© Îì§Ïñ¥ ÏûàÏäµÎãàÎã§. ${b}ÏÉÅÏûêÏóêÎäî Ïó∞ÌïÑÏù¥ Î™®Îëê Î™á ÏûêÎ£® Îì§Ïñ¥ ÏûàÏäµÎãàÍπå?`;
            } else {
                let divisor, quotient;
                if (currentDifficulty === 1) {
                    divisor = random(1, 9);
                    quotient = random(1, 9);
                } else if (currentDifficulty === 2) {
                    divisor = random(1, 9);
                    quotient = random(10, 99);
                } else if (currentDifficulty === 3) {
                    divisor = random(10, 99);
                    quotient = random(10, 99);
                } else if (currentDifficulty === 4) {
                    divisor = random(10, 99);
                    quotient = random(100, 999);
                } else if (currentDifficulty === 5) {
                    divisor = random(100, 999);
                    quotient = random(100, 999);
                } else {
                    divisor = random(100, 999);
                    quotient = random(1000, 9999);
                }
                const dividend = divisor * quotient;
                answer = quotient;
                problem = `Í≥ºÏûê ${dividend}Í∞úÎ•º ${divisor}Î™ÖÏùò ÏπúÍµ¨Îì§ÏóêÍ≤å ÎòëÍ∞ôÏù¥ ÎÇòÎàÑÏñ¥ Ï£ºÎ†§Í≥† Ìï©ÎãàÎã§. Ìïú Î™ÖÏù¥ Î∞õÏùÑ Ïàò ÏûàÎäî Í≥ºÏûêÎäî Î™á Í∞úÏûÖÎãàÍπå?`;
            }

            return {
                type: 'word_problem',
                problem,
                answer,
                canToggleFormat: false
            };
        }

        function displayProblem() {
            problemCtx.clearRect(0, 0, problemCanvas.width, problemCanvas.height);

            const prob = currentProblem;
            const centerX = problemCanvas.width / 2;
            const centerY = problemCanvas.height / 2;

            const formatSelector = document.getElementById('formatSelector');
            if (prob.canToggleFormat) {
                formatSelector.style.display = 'block';
            } else {
                formatSelector.style.display = 'none';
            }

            let fontSize = 48;
            const maxNum = Math.max(prob.a || 0, prob.b || 0, prob.dividend || 0, prob.divisor || 0);

            // Î™®Î∞îÏùº ÌôîÎ©¥ ÌÅ¨Í∏∞Ïóê Îî∞Î•∏ Ìè∞Ìä∏ Ï°∞Ï†ï
            if (window.innerWidth <= 480) {
                if (maxNum > 9999) fontSize = 24;
                else if (maxNum > 999) fontSize = 28;
                else if (maxNum > 99) fontSize = 32;
                else fontSize = 36;
            } else if (window.innerWidth <= 768) {
                if (maxNum > 9999) fontSize = 28;
                else if (maxNum > 999) fontSize = 34;
                else if (maxNum > 99) fontSize = 38;
                else fontSize = 42;
            } else {
                if (maxNum > 9999) fontSize = 32;
                else if (maxNum > 999) fontSize = 38;
                else if (maxNum > 99) fontSize = 42;
            }

            problemCtx.font = `bold ${fontSize}px Arial`;
            problemCtx.fillStyle = '#2d3748';
            problemCtx.textAlign = 'center';
            problemCtx.textBaseline = 'middle';

            if (prob.type === 'addition') {
                if (currentFormat === 'inline') {
                    const text = `${prob.a} + ${prob.b} = ?`;
                    problemCtx.fillText(text, centerX, centerY);
                } else {
                    problemCtx.textAlign = 'right';
                    const offsetX = centerX + (window.innerWidth <= 480 ? 60 : 100);
                    const spacing = window.innerWidth <= 480 ? 30 : 40;
                    problemCtx.fillText(String(prob.a), offsetX, centerY - spacing);
                    problemCtx.fillText(`+ ${prob.b}`, offsetX, centerY);
                    problemCtx.beginPath();
                    const lineWidth = window.innerWidth <= 480 ? 150 : 200;
                    problemCtx.moveTo(centerX - 50, centerY + 20);
                    problemCtx.lineTo(centerX + lineWidth - 50, centerY + 20);
                    problemCtx.strokeStyle = '#2d3748';
                    problemCtx.lineWidth = 3;
                    problemCtx.stroke();
                    problemCtx.fillText('?', offsetX, centerY + spacing + 20);
                }
            } else if (prob.type === 'subtraction') {
                if (currentFormat === 'inline') {
                    const text = `${prob.a} - ${prob.b} = ?`;
                    problemCtx.fillText(text, centerX, centerY);
                } else {
                    problemCtx.textAlign = 'right';
                    const offsetX = centerX + (window.innerWidth <= 480 ? 60 : 100);
                    const spacing = window.innerWidth <= 480 ? 30 : 40;
                    problemCtx.fillText(String(prob.a), offsetX, centerY - spacing);
                    problemCtx.fillText(`- ${prob.b}`, offsetX, centerY);
                    problemCtx.beginPath();
                    const lineWidth = window.innerWidth <= 480 ? 150 : 200;
                    problemCtx.moveTo(centerX - 50, centerY + 20);
                    problemCtx.lineTo(centerX + lineWidth - 50, centerY + 20);
                    problemCtx.strokeStyle = '#2d3748';
                    problemCtx.lineWidth = 3;
                    problemCtx.stroke();
                    problemCtx.fillText('?', offsetX, centerY + spacing + 20);
                }
            } else if (prob.type === 'multiplication') {
                if (currentFormat === 'inline') {
                    const text = `${prob.a} √ó ${prob.b} = ?`;
                    problemCtx.fillText(text, centerX, centerY);
                } else {
                    problemCtx.textAlign = 'right';
                    const offsetX = centerX + (window.innerWidth <= 480 ? 60 : 100);
                    const spacing = window.innerWidth <= 480 ? 30 : 40;
                    problemCtx.fillText(String(prob.a), offsetX, centerY - spacing);
                    problemCtx.fillText(`√ó ${prob.b}`, offsetX, centerY);
                    problemCtx.beginPath();
                    const lineWidth = window.innerWidth <= 480 ? 150 : 200;
                    problemCtx.moveTo(centerX - 50, centerY + 20);
                    problemCtx.lineTo(centerX + lineWidth - 50, centerY + 20);
                    problemCtx.strokeStyle = '#2d3748';
                    problemCtx.lineWidth = 3;
                    problemCtx.stroke();
                    problemCtx.fillText('?', offsetX, centerY + spacing + 20);
                }
            } else if (prob.type === 'division') {
                if (maxNum > 9999) fontSize = window.innerWidth <= 480 ? 20 : 28;
                else if (maxNum > 999) fontSize = window.innerWidth <= 480 ? 24 : 34;
                problemCtx.font = `bold ${fontSize}px Arial`;

                problemCtx.textAlign = 'left';
                const leftOffset = window.innerWidth <= 480 ? 100 : 150;
                problemCtx.fillText(String(prob.divisor), centerX - leftOffset, centerY + 15);

                problemCtx.beginPath();
                const divHeight = window.innerWidth <= 480 ? 50 : 60;
                const divWidth = window.innerWidth <= 480 ? 100 : 150;
                problemCtx.moveTo(centerX - 80, centerY - divHeight);
                problemCtx.lineTo(centerX - 80, centerY + divHeight);
                problemCtx.moveTo(centerX - 80, centerY - divHeight);
                problemCtx.lineTo(centerX + divWidth - 80, centerY - divHeight);
                problemCtx.strokeStyle = '#2d3748';
                problemCtx.lineWidth = 4;
                problemCtx.stroke();

                problemCtx.textAlign = 'center';
                problemCtx.fillText(String(prob.dividend), centerX + 20, centerY + 15);
            } else if (prob.type === 'word_problem') {
                const wordFontSize = window.innerWidth <= 480 ? 14 : (window.innerWidth <= 768 ? 16 : 18);
                problemCtx.font = `bold ${wordFontSize}px Arial`;
                problemCtx.textAlign = 'left';
                const words = prob.problem;
                const maxWidth = problemCanvas.width - (window.innerWidth <= 480 ? 40 : 80);
                const lines = wrapText(problemCtx, words, maxWidth);
                const lineHeight = window.innerWidth <= 480 ? 22 : 28;
                const startY = centerY - (lines.length * lineHeight) / 2;
                const leftPadding = window.innerWidth <= 480 ? 20 : 40;

                lines.forEach((line, i) => {
                    problemCtx.fillText(line, leftPadding, startY + i * lineHeight);
                });
            }
        }

        function wrapText(ctx, text, maxWidth) {
            const words = text.split('');
            const lines = [];
            let currentLine = '';

            for (let i = 0; i < words.length; i++) {
                const testLine = currentLine + words[i];
                const metrics = ctx.measureText(testLine);

                if (metrics.width > maxWidth && currentLine !== '') {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        function checkAnswer() {
            if (currentAnswer === '') {
                alert('ÎãµÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            totalCount++;
            document.getElementById('totalCount').textContent = totalCount;

            const userAnswer = parseInt(currentAnswer);
            const correctAnswer = currentProblem.answer;

            const overlay = document.getElementById('overlay');
            const popup = document.getElementById('resultPopup');
            const icon = document.getElementById('resultIcon');
            const text = document.getElementById('resultText');
            const expGainDiv = document.getElementById('expGain');

            if (userAnswer === correctAnswer) {
                correctCount++;
                document.getElementById('correctCount').textContent = correctCount;

                icon.textContent = 'üéâ';
                text.textContent = 'Ï†ïÎãµÏûÖÎãàÎã§!';
                text.className = 'result-text result-correct';

                const expGain = currentDifficulty * 2;
                expGainDiv.innerHTML = `<div style="color: #00b894; font-size: 1.2em; margin: 10px 0;">+${expGain} EXP</div>`;

                gainExp(expGain);
            } else {
                icon.textContent = 'üò¢';
                text.textContent = 'ÌãÄÎ†∏ÏäµÎãàÎã§!';
                text.className = 'result-text result-incorrect';
                expGainDiv.innerHTML = `<div style="color: #636e72; margin: 10px 0;">Ï†ïÎãµ: ${correctAnswer}</div>`;
            }

            overlay.classList.add('show');
            popup.classList.add('show');
        }

        function gainExp(amount) {
            exp += amount;

            while (exp >= expNeeded) {
                levelUp();
                exp -= expNeeded;
                expNeeded = 20;
            }

            updateExpBar();
        }

        function levelUp() {
            level++;
            document.getElementById('level').textContent = `Level ${level}`;

            const charIndex = (level - 1) % characters.length;
            document.getElementById('character').textContent = characters[charIndex];
        }

        function updateExpBar() {
            const percentage = (exp / expNeeded) * 100;
            document.getElementById('expFill').style.width = percentage + '%';
            document.getElementById('expFill').textContent = `${exp} / ${expNeeded}`;
        }

        function nextProblem() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('resultPopup').classList.remove('show');
            generateProblem();
        }
    </script>
</body>
</html>
