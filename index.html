<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏàòÌïô Î†àÎ≤®ÏóÖ Í≤åÏûÑ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .difficulty-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .difficulty-btn {
            padding: 10px 20px;
            font-size: 15px;
            border: 3px solid #f39c12;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: #f39c12;
        }
        
        .difficulty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .difficulty-btn.active {
            background: #f39c12;
            color: white;
        }
        
        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .character-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 15px;
        }
        
        .character {
            font-size: 100px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .character-info {
            text-align: left;
        }
        
        .level {
            font-size: 2em;
            font-weight: bold;
            color: #d63031;
            margin-bottom: 10px;
        }
        
        .exp-bar {
            width: 300px;
            height: 30px;
            background: #dfe6e9;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b894 0%, #00cec9 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .stats {
            margin-top: 10px;
            font-size: 1.1em;
            color: #2d3748;
        }
        
        .problem-type-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .type-btn {
            padding: 12px 24px;
            font-size: 16px;
            border: 3px solid #667eea;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: #667eea;
        }
        
        .type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .type-btn.active {
            background: #667eea;
            color: white;
        }
        
        .problem-container {
            padding: 30px;
            background: #f7fafc;
            border-radius: 15px;
            margin-bottom: 25px;
            min-height: 400px;
            border: 3px solid #e2e8f0;
            position: relative;
        }
        
        .drawing-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .drawing-btn {
            padding: 8px 16px;
            font-size: 14px;
            border: 2px solid #cbd5e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        
        .drawing-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .drawing-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #cbd5e0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .color-btn:hover {
            transform: scale(1.1);
        }
        
        .color-btn.active {
            border-color: #2d3748;
            border-width: 4px;
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            height: 350px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #problemCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            pointer-events: none;
        }
        
        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            cursor: crosshair;
        }
        
        .format-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .format-btn {
            padding: 10px 20px;
            margin: 0 5px;
            font-size: 14px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: #667eea;
        }
        
        .format-btn:hover {
            transform: translateY(-1px);
        }
        
        .format-btn.active {
            background: #667eea;
            color: white;
        }
        
        .problem-title {
            font-size: 1.5em;
            color: #2d3748;
            margin-bottom: 25px;
            font-weight: bold;
            text-align: center;
        }
        
        .inline-problem {
            font-size: 2.5em;
            text-align: center;
            color: #2d3748;
            margin: 30px 0;
            font-weight: bold;
        }
        
        .math-symbol {
            display: inline-block;
            margin: 0 10px;
        }
        
        .vertical-problem {
            display: inline-block;
            text-align: right;
            font-size: 2.5em;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }
        
        .vertical-line {
            border-bottom: 4px solid #2d3748;
            margin: 8px 0;
        }
        
        .division-problem {
            display: inline-block;
            font-size: 2.5em;
            font-family: 'Courier New', monospace;
            padding: 25px;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            position: relative;
        }
        
        .division-container {
            position: relative;
            display: inline-block;
        }
        
        .dividend {
            display: inline-block;
            padding: 10px 30px 10px 15px;
            border-left: 4px solid #2d3748;
            border-top: 4px solid #2d3748;
            margin-left: 60px;
        }
        
        .divisor {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .word-problem {
            font-size: 1.5em;
            line-height: 2;
            color: #2d3748;
            padding: 25px;
            background: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .answer-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .answer-display {
            font-size: 2em;
            margin-bottom: 20px;
            color: #2d3748;
            min-height: 50px;
            font-weight: bold;
        }
        
        .number-pad {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto 20px;
        }
        
        .number-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .num-btn {
            padding: 20px 30px;
            font-size: 1.8em;
            background: white;
            border: 3px solid #cbd5e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            color: #2d3748;
            min-width: 80px;
        }
        
        .num-btn:hover {
            background: #edf2f7;
            transform: scale(1.05);
        }
        
        .num-btn:active {
            transform: scale(0.95);
        }
        
        .btn-clear {
            background: #fc8181;
            border-color: #fc8181;
            color: white;
        }
        
        .btn-clear:hover {
            background: #f56565;
        }
        
        .btn-submit {
            padding: 15px 40px;
            font-size: 1.3em;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 15px;
            transition: all 0.3s;
        }
        
        .btn-submit:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .result-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 1000;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .result-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .result-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .result-text {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .result-correct {
            color: #48bb78;
        }
        
        .result-incorrect {
            color: #f56565;
        }
        
        .btn-next {
            padding: 15px 40px;
            font-size: 1.2em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .btn-next:hover {
            background: #5568d3;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
        
        .center-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ ÏàòÌïô Î†àÎ≤®ÏóÖ Í≤åÏûÑ</h1>
        </div>
        
        <div class="difficulty-selector">
            <button class="difficulty-btn" onclick="selectDifficulty(1)">‚≠ê 1Îã®Í≥Ñ</button>
            <button class="difficulty-btn" onclick="selectDifficulty(2)">‚≠ê‚≠ê 2Îã®Í≥Ñ</button>
            <button class="difficulty-btn active" onclick="selectDifficulty(3)">‚≠ê‚≠ê‚≠ê 3Îã®Í≥Ñ</button>
            <button class="difficulty-btn" onclick="selectDifficulty(4)">‚≠ê‚≠ê‚≠ê‚≠ê 4Îã®Í≥Ñ</button>
            <button class="difficulty-btn" onclick="selectDifficulty(5)">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5Îã®Í≥Ñ</button>
            <button class="difficulty-btn" onclick="selectDifficulty(6)">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 6Îã®Í≥Ñ</button>
        </div>
        
        <div class="character-section">
            <div class="character" id="character">üê±</div>
            <div class="character-info">
                <div class="level" id="level">Level 1</div>
                <div class="exp-bar">
                    <div class="exp-fill" id="expFill">0 / 10</div>
                </div>
                <div class="stats">
                    <div>Ï†ïÎãµ: <span id="correctCount">0</span>Í∞ú ‚úì</div>
                    <div>Ï¥ù Î¨∏Ï†ú: <span id="totalCount">0</span>Í∞ú</div>
                    <div style="color: #667eea; font-weight: bold; margin-top: 5px;">
                        ÎÇúÏù¥ÎèÑÎ≥Ñ Ï†êÏàò: 1Îã®Í≥Ñ(2Ï†ê) ~ 6Îã®Í≥Ñ(12Ï†ê)<br>
                        <small>1Îã®Í≥Ñ=1ÏûêÎ¶¨, 2Îã®Í≥Ñ=2ÏûêÎ¶¨, 3Îã®Í≥Ñ=3ÏûêÎ¶¨...</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="problem-type-selector">
            <button class="type-btn active" onclick="selectType('all')">Ï†ÑÏ≤¥ ÎûúÎç§</button>
            <button class="type-btn" onclick="selectType('addition')">‚ûï ÎçßÏÖà</button>
            <button class="type-btn" onclick="selectType('subtraction')">‚ûñ Î∫ÑÏÖà</button>
            <button class="type-btn" onclick="selectType('multiplication')">‚úñÔ∏è Í≥±ÏÖà</button>
            <button class="type-btn" onclick="selectType('division')">‚ûó ÎÇòÎàóÏÖà</button>
            <button class="type-btn" onclick="selectType('word')">üìù ÏÑúÏà†Ìòï</button>
        </div>
        
        <div class="problem-container">
            <div class="drawing-controls">
                <button class="drawing-btn" onclick="toggleDrawing()" id="drawingToggle">üñäÔ∏è Í∑∏Î¶ºÌåê ÏºúÍ∏∞</button>
                <button class="color-btn" onclick="changeColor('#000000')" style="background: #000000;" id="color-black"></button>
                <button class="color-btn" onclick="changeColor('#ff0000')" style="background: #ff0000;"></button>
                <button class="color-btn" onclick="changeColor('#0000ff')" style="background: #0000ff;"></button>
                <button class="color-btn" onclick="changeColor('#00ff00')" style="background: #00ff00;"></button>
                <button class="color-btn" onclick="changeColor('#ff00ff')" style="background: #ff00ff;"></button>
                <button class="drawing-btn" onclick="changeLineWidth(2)">Í∞ÄÎäî ÏÑ†</button>
                <button class="drawing-btn" onclick="changeLineWidth(5)">Ï§ëÍ∞Ñ ÏÑ†</button>
                <button class="drawing-btn" onclick="changeLineWidth(10)">ÍµµÏùÄ ÏÑ†</button>
                <button class="drawing-btn" onclick="useEraser()">ÏßÄÏö∞Í∞ú</button>
                <button class="drawing-btn" onclick="clearCanvas()">Ï†ÑÏ≤¥ ÏßÄÏö∞Í∏∞</button>
            </div>
            
            <div class="format-selector" id="formatSelector" style="display: none;">
                <button class="format-btn active" onclick="changeFormat('inline')">ÏùºÏûêÌòï</button>
                <button class="format-btn" onclick="changeFormat('vertical')">ÎëêÏ§ÑÌòï</button>
            </div>
            
            <div class="canvas-container">
                <canvas id="drawingCanvas"></canvas>
                <canvas id="problemCanvas"></canvas>
            </div>
            
            <div class="answer-section">
                <div class="answer-display" id="answerDisplay">Îãµ: </div>
                <div class="number-pad">
                    <div class="number-row">
                        <button class="num-btn" onclick="addNumber(1)">1</button>
                        <button class="num-btn" onclick="addNumber(2)">2</button>
                        <button class="num-btn" onclick="addNumber(3)">3</button>
                        <button class="num-btn" onclick="addNumber(4)">4</button>
                        <button class="num-btn" onclick="addNumber(5)">5</button>
                    </div>
                    <div class="number-row">
                        <button class="num-btn" onclick="addNumber(6)">6</button>
                        <button class="num-btn" onclick="addNumber(7)">7</button>
                        <button class="num-btn" onclick="addNumber(8)">8</button>
                        <button class="num-btn" onclick="addNumber(9)">9</button>
                        <button class="num-btn" onclick="addNumber(0)">0</button>
                        <button class="num-btn btn-clear" onclick="clearAnswer()">‚Üê</button>
                    </div>
                </div>
                <button class="btn-submit" onclick="checkAnswer()">Ï†úÏ∂úÌïòÍ∏∞</button>
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div class="result-popup" id="resultPopup">
        <div class="result-icon" id="resultIcon"></div>
        <div class="result-text" id="resultText"></div>
        <div id="expGain"></div>
        <button class="btn-next" onclick="nextProblem()">Îã§Ïùå Î¨∏Ï†ú</button>
    </div>
    
    <script>
        let currentType = 'all';
        let currentProblem = null;
        let currentFormat = 'inline';
        let currentAnswer = '';
        let currentDifficulty = 3;
        let level = 1;
        let exp = 0;
        let expNeeded = 20;
        let correctCount = 0;
        let totalCount = 0;
        
        // Í∑∏Î¶ºÌåê Í¥ÄÎ†® Î≥ÄÏàò
        let drawingCanvas, problemCanvas;
        let drawingCtx, problemCtx;
        let isDrawing = false;
        let drawingEnabled = true; // Í∏∞Î≥∏Í∞íÏùÑ trueÎ°ú Î≥ÄÍ≤Ω
        let currentColor = '#000000';
        let currentLineWidth = 3;
        let lastX = 0;
        let lastY = 0;
        
        const characters = ['üê±', 'üê∂', 'üêº', 'ü¶Å', 'üêØ', 'ü¶ä', 'üê∞', 'üêª', 'üê®', 'üêµ'];
        
        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        // Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî
        function initCanvas() {
            drawingCanvas = document.getElementById('drawingCanvas');
            problemCanvas = document.getElementById('problemCanvas');
            drawingCtx = drawingCanvas.getContext('2d');
            problemCtx = problemCanvas.getContext('2d');
            
            const container = drawingCanvas.parentElement;
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            
            drawingCanvas.width = width;
            drawingCanvas.height = height;
            problemCanvas.width = width;
            problemCanvas.height = height;
            
            // Í∑∏Î¶ºÌåê Ï∫îÎ≤ÑÏä§Î•º Ìà¨Î™ÖÌïòÍ≤å Ï¥àÍ∏∞Ìôî
            drawingCtx.clearRect(0, 0, width, height);
            
            // Í∑∏Î¶ºÌåê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);
            
            // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏
            drawingCanvas.addEventListener('touchstart', handleTouch);
            drawingCanvas.addEventListener('touchmove', handleTouch);
            drawingCanvas.addEventListener('touchend', stopDrawing);
            
            document.getElementById('color-black').classList.add('active');
            
            // Í∑∏Î¶ºÌåê Î≤ÑÌäº Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï
            const drawingToggle = document.getElementById('drawingToggle');
            drawingToggle.textContent = 'üñäÔ∏è Í∑∏Î¶ºÌåê ÎÅÑÍ∏∞';
            drawingToggle.classList.add('active');
        }
        
        function toggleDrawing() {
            drawingEnabled = !drawingEnabled;
            const btn = document.getElementById('drawingToggle');
            if (drawingEnabled) {
                btn.textContent = 'üñäÔ∏è Í∑∏Î¶ºÌåê ÎÅÑÍ∏∞';
                btn.classList.add('active');
            } else {
                btn.textContent = 'üñäÔ∏è Í∑∏Î¶ºÌåê ÏºúÍ∏∞';
                btn.classList.remove('active');
            }
        }
        
        function startDrawing(e) {
            if (!drawingEnabled) return;
            isDrawing = true;
            const rect = drawingCanvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }
        
        function draw(e) {
            if (!isDrawing || !drawingEnabled) return;
            
            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            drawingCtx.beginPath();
            drawingCtx.moveTo(lastX, lastY);
            drawingCtx.lineTo(x, y);
            drawingCtx.strokeStyle = currentColor;
            drawingCtx.lineWidth = currentLineWidth;
            drawingCtx.lineCap = 'round';
            drawingCtx.stroke();
            
            lastX = x;
            lastY = y;
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        function handleTouch(e) {
            e.preventDefault();
            if (!drawingEnabled) return;
            
            const touch = e.touches[0];
            const rect = drawingCanvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            if (e.type === 'touchstart') {
                isDrawing = true;
                lastX = x;
                lastY = y;
            } else if (e.type === 'touchmove' && isDrawing) {
                drawingCtx.beginPath();
                drawingCtx.moveTo(lastX, lastY);
                drawingCtx.lineTo(x, y);
                drawingCtx.strokeStyle = currentColor;
                drawingCtx.lineWidth = currentLineWidth;
                drawingCtx.lineCap = 'round';
                drawingCtx.stroke();
                
                lastX = x;
                lastY = y;
            }
        }
        
        function changeColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function changeLineWidth(width) {
            currentLineWidth = width;
        }
        
        function useEraser() {
            currentColor = '#ffffff';
            currentLineWidth = 20;
        }
        
        function clearCanvas() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        }
        
        function selectDifficulty(difficulty) {
            currentDifficulty = difficulty;
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            generateProblem();
        }
        
        function selectType(type) {
            currentType = type;
            currentFormat = 'inline';
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            generateProblem();
        }
        
        function changeFormat(format) {
            currentFormat = format;
            document.querySelectorAll('.format-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayProblem();
        }
        
        function addNumber(num) {
            currentAnswer += num.toString();
            document.getElementById('answerDisplay').textContent = 'Îãµ: ' + currentAnswer;
        }
        
        function clearAnswer() {
            currentAnswer = currentAnswer.slice(0, -1);
            document.getElementById('answerDisplay').textContent = 'Îãµ: ' + (currentAnswer || '');
        }
        
        function generateProblem() {
            currentAnswer = '';
            document.getElementById('answerDisplay').textContent = 'Îãµ: ';
            
            const types = currentType === 'all' 
                ? ['addition', 'subtraction', 'multiplication', 'division', 'word']
                : [currentType];
            
            const selectedType = types[random(0, types.length - 1)];
            
            if (selectedType === 'addition') {
                currentProblem = generateAddition();
            } else if (selectedType === 'subtraction') {
                currentProblem = generateSubtraction();
            } else if (selectedType === 'multiplication') {
                currentProblem = generateMultiplication();
            } else if (selectedType === 'division') {
                currentProblem = generateDivision();
            } else {
                currentProblem = generateWordProblem();
            }
            
            displayProblem();
        }
        
        function generateAddition() {
            let min, max;
            switch(currentDifficulty) {
                case 1: min = 1; max = 9; break;        // 1ÏûêÎ¶¨Ïàò
                case 2: min = 10; max = 99; break;      // 2ÏûêÎ¶¨Ïàò
                case 3: min = 100; max = 999; break;    // 3ÏûêÎ¶¨Ïàò
                case 4: min = 1000; max = 9999; break;  // 4ÏûêÎ¶¨Ïàò
                case 5: min = 10000; max = 99999; break; // 5ÏûêÎ¶¨Ïàò
                case 6: min = 100000; max = 999999; break; // 6ÏûêÎ¶¨Ïàò
            }
            const a = random(min, max);
            const b = random(min, max);
            return {
                type: 'addition',
                a, b,
                answer: a + b,
                canToggleFormat: true
            };
        }
        
        function generateSubtraction() {
            let min, max;
            switch(currentDifficulty) {
                case 1: min = 1; max = 9; break;        // 1ÏûêÎ¶¨Ïàò
                case 2: min = 10; max = 99; break;      // 2ÏûêÎ¶¨Ïàò
                case 3: min = 100; max = 999; break;    // 3ÏûêÎ¶¨Ïàò
                case 4: min = 1000; max = 9999; break;  // 4ÏûêÎ¶¨Ïàò
                case 5: min = 10000; max = 99999; break; // 5ÏûêÎ¶¨Ïàò
                case 6: min = 100000; max = 999999; break; // 6ÏûêÎ¶¨Ïàò
            }
            const a = random(min, max);
            const b = random(Math.floor(min/2), a - 1);
            return {
                type: 'subtraction',
                a, b,
                answer: a - b,
                canToggleFormat: true
            };
        }
        
        function generateMultiplication() {
            let minA, maxA, minB, maxB;
            switch(currentDifficulty) {
                case 1: minA = 1; maxA = 9; minB = 1; maxB = 9; break;          // 1ÏûêÎ¶¨ √ó 1ÏûêÎ¶¨
                case 2: minA = 10; maxA = 99; minB = 1; maxB = 9; break;        // 2ÏûêÎ¶¨ √ó 1ÏûêÎ¶¨
                case 3: minA = 10; maxA = 99; minB = 10; maxB = 99; break;      // 2ÏûêÎ¶¨ √ó 2ÏûêÎ¶¨
                case 4: minA = 100; maxA = 999; minB = 10; maxB = 99; break;    // 3ÏûêÎ¶¨ √ó 2ÏûêÎ¶¨
                case 5: minA = 100; maxA = 999; minB = 100; maxB = 999; break;  // 3ÏûêÎ¶¨ √ó 3ÏûêÎ¶¨
                case 6: minA = 1000; maxA = 9999; minB = 100; maxB = 999; break; // 4ÏûêÎ¶¨ √ó 3ÏûêÎ¶¨
            }
            const a = random(minA, maxA);
            const b = random(minB, maxB);
            return {
                type: 'multiplication',
                a, b,
                answer: a * b,
                canToggleFormat: true
            };
        }
        
        function generateDivision() {
            let minDiv, maxDiv, minQuot, maxQuot;
            switch(currentDifficulty) {
                case 1: minDiv = 1; maxDiv = 9; minQuot = 1; maxQuot = 9; break;       // 1ÏûêÎ¶¨
                case 2: minDiv = 1; maxDiv = 9; minQuot = 10; maxQuot = 99; break;     // 2ÏûêÎ¶¨ √∑ 1ÏûêÎ¶¨
                case 3: minDiv = 10; maxDiv = 99; minQuot = 10; maxQuot = 99; break;   // 3ÏûêÎ¶¨ √∑ 2ÏûêÎ¶¨
                case 4: minDiv = 10; maxDiv = 99; minQuot = 100; maxQuot = 999; break; // 4ÏûêÎ¶¨ √∑ 2ÏûêÎ¶¨
                case 5: minDiv = 100; maxDiv = 999; minQuot = 100; maxQuot = 999; break; // 5ÏûêÎ¶¨ √∑ 3ÏûêÎ¶¨
                case 6: minDiv = 100; maxDiv = 999; minQuot = 1000; maxQuot = 9999; break; // 6ÏûêÎ¶¨ √∑ 3ÏûêÎ¶¨
            }
            const divisor = random(minDiv, maxDiv);
            const quotient = random(minQuot, maxQuot);
            const dividend = divisor * quotient;
            return {
                type: 'division',
                dividend, divisor,
                answer: quotient,
                canToggleFormat: false
            };
        }
        
        function generateWordProblem() {
            const type = random(1, 4);
            let problem, answer;
            let min, max;
            
            switch(currentDifficulty) {
                case 1: min = 1; max = 9; break;        // 1ÏûêÎ¶¨Ïàò
                case 2: min = 10; max = 99; break;      // 2ÏûêÎ¶¨Ïàò
                case 3: min = 100; max = 999; break;    // 3ÏûêÎ¶¨Ïàò
                case 4: min = 1000; max = 9999; break;  // 4ÏûêÎ¶¨Ïàò
                case 5: min = 10000; max = 99999; break; // 5ÏûêÎ¶¨Ïàò
                case 6: min = 100000; max = 999999; break; // 6ÏûêÎ¶¨Ïàò
            }
            
            if (type === 1) {
                const a = random(min, max);
                const b = random(min, max);
                answer = a + b;
                problem = `Ï≤†ÏàòÎäî ÏÇ¨Í≥ºÎ•º ${a}Í∞ú Í∞ÄÏßÄÍ≥† ÏûàÏóàÏäµÎãàÎã§. ÏòÅÌù¨Í∞Ä ÏÇ¨Í≥º ${b}Í∞úÎ•º Îçî Ï£ºÏóàÏäµÎãàÎã§. Ï≤†ÏàòÍ∞Ä Í∞ÄÏßÑ ÏÇ¨Í≥ºÎäî Î™®Îëê Î™á Í∞úÏûÖÎãàÍπå?`;
            } else if (type === 2) {
                const a = random(Math.floor(min * 1.5), max);
                const b = random(min, a - 1);
                answer = a - b;
                problem = `Í∞ÄÍ≤åÏóê ÎπµÏù¥ ${a}Í∞ú ÏûàÏóàÏäµÎãàÎã§. ÏÜêÎãòÎì§Ïù¥ ${b}Í∞úÎ•º ÏÉÄÏäµÎãàÎã§. ÎÇ®ÏùÄ ÎπµÏùÄ Î™á Í∞úÏûÖÎãàÍπå?`;
            } else if (type === 3) {
                let minMult, maxMult, minCount, maxCount;
                if (currentDifficulty === 1) {
                    minMult = 1; maxMult = 9; minCount = 1; maxCount = 9;
                } else if (currentDifficulty === 2) {
                    minMult = 10; maxMult = 99; minCount = 1; maxCount = 9;
                } else if (currentDifficulty === 3) {
                    minMult = 10; maxMult = 99; minCount = 10; maxCount = 99;
                } else if (currentDifficulty === 4) {
                    minMult = 100; maxMult = 999; minCount = 10; maxCount = 99;
                } else if (currentDifficulty === 5) {
                    minMult = 100; maxMult = 999; minCount = 100; maxCount = 999;
                } else {
                    minMult = 1000; maxMult = 9999; minCount = 100; maxCount = 999;
                }
                const a = random(minMult, maxMult);
                const b = random(minCount, maxCount);
                answer = a * b;
                problem = `Ìïú ÏÉÅÏûêÏóê Ïó∞ÌïÑÏù¥ ${a}ÏûêÎ£®Ïî© Îì§Ïñ¥ ÏûàÏäµÎãàÎã§. ${b}ÏÉÅÏûêÏóêÎäî Ïó∞ÌïÑÏù¥ Î™®Îëê Î™á ÏûêÎ£® Îì§Ïñ¥ ÏûàÏäµÎãàÍπå?`;
            } else {
                let divisor, quotient;
                if (currentDifficulty === 1) {
                    divisor = random(1, 9);
                    quotient = random(1, 9);
                } else if (currentDifficulty === 2) {
                    divisor = random(1, 9);
                    quotient = random(10, 99);
                } else if (currentDifficulty === 3) {
                    divisor = random(10, 99);
                    quotient = random(10, 99);
                } else if (currentDifficulty === 4) {
                    divisor = random(10, 99);
                    quotient = random(100, 999);
                } else if (currentDifficulty === 5) {
                    divisor = random(100, 999);
                    quotient = random(100, 999);
                } else {
                    divisor = random(100, 999);
                    quotient = random(1000, 9999);
                }
                const dividend = divisor * quotient;
                answer = quotient;
                problem = `Í≥ºÏûê ${dividend}Í∞úÎ•º ${divisor}Î™ÖÏùò ÏπúÍµ¨Îì§ÏóêÍ≤å ÎòëÍ∞ôÏù¥ ÎÇòÎàÑÏñ¥ Ï£ºÎ†§Í≥† Ìï©ÎãàÎã§. Ìïú Î™ÖÏù¥ Î∞õÏùÑ Ïàò ÏûàÎäî Í≥ºÏûêÎäî Î™á Í∞úÏûÖÎãàÍπå?`;
            }
            
            return {
                type: 'word_problem',
                problem,
                answer,
                canToggleFormat: false
            };
        }
        
        function displayProblem() {
            // Î¨∏Ï†ú Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî
            problemCtx.clearRect(0, 0, problemCanvas.width, problemCanvas.height);
            
            const prob = currentProblem;
            const centerX = problemCanvas.width / 2;
            const centerY = problemCanvas.height / 2;
            
            // ÌòïÏãù ÏÑ†ÌÉù Î≤ÑÌäº ÌëúÏãú/Ïà®ÍπÄ
            const formatSelector = document.getElementById('formatSelector');
            if (prob.canToggleFormat) {
                formatSelector.style.display = 'block';
            } else {
                formatSelector.style.display = 'none';
            }
            
            // Ïà´Ïûê Í∏∏Ïù¥Ïóê Îî∞Îùº Ìè∞Ìä∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï
            let fontSize = 48;
            const maxNum = Math.max(prob.a || 0, prob.b || 0, prob.dividend || 0, prob.divisor || 0);
            if (maxNum > 9999) fontSize = 32;
            else if (maxNum > 999) fontSize = 38;
            else if (maxNum > 99) fontSize = 42;
            
            problemCtx.font = `bold ${fontSize}px Arial`;
            problemCtx.fillStyle = '#2d3748';
            problemCtx.textAlign = 'center';
            problemCtx.textBaseline = 'middle';
            
            if (prob.type === 'addition') {
                if (currentFormat === 'inline') {
                    const text = `${prob.a} + ${prob.b} = ?`;
                    problemCtx.fillText(text, centerX, centerY);
                } else {
                    problemCtx.textAlign = 'right';
                    const offsetX = centerX + 100;
                    problemCtx.fillText(String(prob.a), offsetX, centerY - 40);
                    problemCtx.fillText(`+ ${prob.b}`, offsetX, centerY);
                    problemCtx.beginPath();
                    problemCtx.moveTo(centerX - 100, centerY + 20);
                    problemCtx.lineTo(centerX + 150, centerY + 20);
                    problemCtx.strokeStyle = '#2d3748';
                    problemCtx.lineWidth = 3;
                    problemCtx.stroke();
                    problemCtx.fillText('?', offsetX, centerY + 60);
                }
            } else if (prob.type === 'subtraction') {
                if (currentFormat === 'inline') {
                    const text = `${prob.a} - ${prob.b} = ?`;
                    problemCtx.fillText(text, centerX, centerY);
                } else {
                    problemCtx.textAlign = 'right';
                    const offsetX = centerX + 100;
                    problemCtx.fillText(String(prob.a), offsetX, centerY - 40);
                    problemCtx.fillText(`- ${prob.b}`, offsetX, centerY);
                    problemCtx.beginPath();
                    problemCtx.moveTo(centerX - 100, centerY + 20);
                    problemCtx.lineTo(centerX + 150, centerY + 20);
                    problemCtx.strokeStyle = '#2d3748';
                    problemCtx.lineWidth = 3;
                    problemCtx.stroke();
                    problemCtx.fillText('?', offsetX, centerY + 60);
                }
            } else if (prob.type === 'multiplication') {
                if (currentFormat === 'inline') {
                    const text = `${prob.a} √ó ${prob.b} = ?`;
                    problemCtx.fillText(text, centerX, centerY);
                } else {
                    problemCtx.textAlign = 'right';
                    const offsetX = centerX + 100;
                    problemCtx.fillText(String(prob.a), offsetX, centerY - 40);
                    problemCtx.fillText(`√ó ${prob.b}`, offsetX, centerY);
                    problemCtx.beginPath();
                    problemCtx.moveTo(centerX - 100, centerY + 20);
                    problemCtx.lineTo(centerX + 150, centerY + 20);
                    problemCtx.strokeStyle = '#2d3748';
                    problemCtx.lineWidth = 3;
                    problemCtx.stroke();
                    problemCtx.fillText('?', offsetX, centerY + 60);
                }
            } else if (prob.type === 'division') {
                // ÎÇòÎàóÏÖàÏùÄ Ìè∞Ìä∏ ÌÅ¨Í∏∞ Îçî ÏûëÍ≤å
                if (maxNum > 9999) fontSize = 28;
                else if (maxNum > 999) fontSize = 34;
                problemCtx.font = `bold ${fontSize}px Arial`;
                
                problemCtx.textAlign = 'left';
                
                // ÎÇòÎàÑÎäî Ïàò (ÏôºÏ™Ω)
                problemCtx.fillText(String(prob.divisor), centerX - 150, centerY + 15);
                
                // ÎÇòÎàóÏÖà Í∏∞Ìò∏ Í∑∏Î¶¨Í∏∞
                problemCtx.beginPath();
                // ÏÑ∏Î°úÏÑ†
                problemCtx.moveTo(centerX - 80, centerY - 60);
                problemCtx.lineTo(centerX - 80, centerY + 60);
                // ÏúÑÏ™Ω Í∞ÄÎ°úÏÑ†
                problemCtx.moveTo(centerX - 80, centerY - 60);
                problemCtx.lineTo(centerX + 150, centerY - 60);
                problemCtx.strokeStyle = '#2d3748';
                problemCtx.lineWidth = 4;
                problemCtx.stroke();
                
                // ÎÇòÎà†ÏßÄÎäî Ïàò (ÏïàÏ™Ω)
                problemCtx.textAlign = 'center';
                problemCtx.fillText(String(prob.dividend), centerX + 35, centerY + 15);
            } else if (prob.type === 'word_problem') {
                problemCtx.font = 'bold 18px Arial';
                problemCtx.textAlign = 'left';
                const words = prob.problem;
                const maxWidth = problemCanvas.width - 80;
                const lines = wrapText(problemCtx, words, maxWidth);
                const lineHeight = 28;
                const startY = centerY - (lines.length * lineHeight) / 2;
                
                lines.forEach((line, i) => {
                    problemCtx.fillText(line, 40, startY + i * lineHeight);
                });
            }
        }
        
        function wrapText(ctx, text, maxWidth) {
            const words = text.split('');
            const lines = [];
            let currentLine = '';
            
            for (let i = 0; i < words.length; i++) {
                const testLine = currentLine + words[i];
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && currentLine !== '') {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);
            return lines;
        }
        
        function checkAnswer() {
            const userAnswer = parseInt(currentAnswer);
            
            if (isNaN(userAnswer) || currentAnswer === '') {
                alert('ÎãµÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            totalCount++;
            document.getElementById('totalCount').textContent = totalCount;
            
            const isCorrect = userAnswer === currentProblem.answer;
            
            if (isCorrect) {
                correctCount++;
                document.getElementById('correctCount').textContent = correctCount;
                
                // ÎÇúÏù¥ÎèÑÏóê Îî∞Î•∏ Í≤ΩÌóòÏπò Í≥ÑÏÇ∞
                let expGain = currentDifficulty * 2; // 1Îã®Í≥Ñ=2Ï†ê, 2Îã®Í≥Ñ=4Ï†ê, ..., 6Îã®Í≥Ñ=12Ï†ê
                
                showResult(true, expGain);
                gainExp(expGain);
            } else {
                showResult(false, 0);
            }
        }
        
        function showResult(isCorrect, expGain) {
            const popup = document.getElementById('resultPopup');
            const overlay = document.getElementById('overlay');
            const icon = document.getElementById('resultIcon');
            const text = document.getElementById('resultText');
            const expGainDiv = document.getElementById('expGain');
            
            if (isCorrect) {
                icon.textContent = 'üéâ';
                text.textContent = 'Ï†ïÎãµÏûÖÎãàÎã§!';
                text.className = 'result-text result-correct';
                expGainDiv.innerHTML = `<strong style="color: #48bb78; font-size: 1.3em;">+${expGain} Í≤ΩÌóòÏπò!</strong><br><small style="color: #666;">(${currentDifficulty}Îã®Í≥Ñ Î¨∏Ï†ú)</small>`;
            } else {
                icon.textContent = 'üò¢';
                text.textContent = 'ÌãÄÎ†∏ÏäµÎãàÎã§!';
                text.className = 'result-text result-incorrect';
                expGainDiv.innerHTML = `<div style="color: #f56565; font-size: 1.2em;">Ï†ïÎãµ: ${currentProblem.answer}</div>`;
            }
            
            overlay.classList.add('show');
            popup.classList.add('show');
        }
        
        function gainExp(amount) {
            exp += amount;
            
            // Î†àÎ≤®ÏóÖ Ï≤¥ÌÅ¨ (20Ï†êÎßàÎã§ Î†àÎ≤®ÏóÖ)
            while (exp >= expNeeded) {
                exp -= expNeeded;
                level++;
                // Îã§Ïùå Î†àÎ≤®ÏóÖÏóê ÌïÑÏöîÌïú Í≤ΩÌóòÏπò Í≥†Ï†ï (20Ï†ê)
                expNeeded = 20;
                
                const charIndex = Math.min(level - 1, characters.length - 1);
                document.getElementById('character').textContent = characters[charIndex];
            }
            
            updateDisplay();
        }
        
        function updateDisplay() {
            document.getElementById('level').textContent = `Level ${level}`;
            const expFill = document.getElementById('expFill');
            const percent = (exp / expNeeded) * 100;
            expFill.style.width = percent + '%';
            expFill.textContent = `${exp} / ${expNeeded}`;
        }
        
        function nextProblem() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('resultPopup').classList.remove('show');
            currentFormat = 'inline';
            document.querySelectorAll('.format-btn').forEach((btn, idx) => {
                if (idx === 0) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            clearCanvas();
            generateProblem();
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.addEventListener('load', () => {
            initCanvas();
            generateProblem();
            updateDisplay();
        });
    </script>
</body>
</html>